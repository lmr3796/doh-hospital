#/usr/bin/env python
#coding=utf8

#Running PATH
import re, os, sys, web, json
LOCAL_SERVER_PATH = '/srv/www/doh'
sys.path.append(LOCAL_SERVER_PATH)
import query
urls = (
    '/(\w+)/', 'Mainpage',
    '/(\w+)/dept', 'Dept',
    '/(\w+)/doctor', 'Doctor',
    '/(\w+)/register','Register',
    '/(\w+)/cancelregister','Cancel',
)

app = web.application(urls, globals(), autoreload=False)
application = app.wsgifunc()

class Base_handler():
	def __init__(self):
		self.set_path()
	def set_path(self):
		REQUEST_PATH = re.search(r'(/\w+)/.*',web.ctx.path).group(1)
		RUNNING = LOCAL_SERVER_PATH + REQUEST_PATH 
		os.chdir(RUNNING)
		print >>sys.stderr, 'Running at:', os.getcwd()
		f = open('doh.json', 'r')
		path = json.loads(f.read())
		need = True
		if path['NEED_CHECK_CODE'] == 'False':
			need = False
		if query.set_path(	
						server   = path['SERVER'],
						www_path = path['WWW_PATH'],
						dep_path = path['DEP_PATH'],
						doc_path = www_path + path['DOC_PATH'],
						reg_path = www_path + path['REG_PATH'],
						can_path = www_path + path['CAN_PATH'],
						need_check_code = need
						) != 0:
			'jizz'
		f.close()


class Mainpage(Base_handler):
	def GET(self, name):
		return 'cwd = ' + os.getcwd()
				
class Dept(Base_handler):
	def GET(self, name):
		input_data = web.input(id=None)
		print >> sys.stderr, input_data.id is None
		return query.dept_handler(input_data.id)

class Doctor(Base_handler):
	def GET(self, name):
		input_data = web.input(id=None, deptId=None)
		return query.doc_handler(doc_id=input_data.id, dept_id=input_data.deptId)

class Register(Base_handler):
	def GET(self, name):
		'''Jizz'''

class Cancel(Base_handler):
	def GET(self, name):
		'''Jizz'''

if __name__ == "__main__":
	app.run()
	'''
	You shouldn't close the connection here because app.run()
	do something like fork() and if you conn.close()
	the running app would encounter connection reset problem.
	This is very annoying.
	'''
	
	print >> sys.stderr, ''
